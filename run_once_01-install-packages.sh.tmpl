#!/bin/bash
# chezmoi run_once script: Install system packages
# This script runs once per machine

set -eu

echo "==> Installing system packages..."

{{ if eq .chezmoi.os "linux" }}

# Common packages (same name across all distros)
COMMON_PACKAGES=(
    curl
    git
    neovim
    re2c
    sudo
    wget
    zsh
)

{{ if eq .chezmoi.osRelease.id "arch" }}
# MARK: Arch Linux
echo "Detected: Arch Linux"

DISTRO_PACKAGES=(
    base
    base-devel
    docker
    docker-buildx
    docker-compose
    gd
    iptables-nft
    libzip
    oniguruma
    openssh
    postgresql-libs
    which
)

install_packages() {
    local SUDO=""
    if command -v sudo &> /dev/null && [ "$EUID" -ne 0 ]; then
        SUDO="sudo"
    fi

    $SUDO pacman -Sy --noconfirm

    for pkg in "$@"; do
        if ! pacman -Qi "$pkg" &> /dev/null; then
            echo "Installing: $pkg"
            $SUDO pacman -S --noconfirm "$pkg"
        else
            echo "Already installed: $pkg"
        fi
    done
}

{{ else if or (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian") }}
# MARK: Debian / Ubuntu
echo "Detected: {{ .chezmoi.osRelease.id }}"

DISTRO_PACKAGES=(
    build-essential
    docker.io
    docker-buildx
    docker-compose
    libgd-dev
    libonig-dev
    libpq-dev
    libzip-dev
    openssh-client
)

install_packages() {
    local SUDO=""
    if command -v sudo &> /dev/null && [ "$EUID" -ne 0 ]; then
        SUDO="sudo"
    fi

    $SUDO apt-get update

    for pkg in "$@"; do
        if ! dpkg -l "$pkg" 2>/dev/null | grep -q "^ii"; then
            echo "Installing: $pkg"
            $SUDO apt-get install -y "$pkg"
        else
            echo "Already installed: $pkg"
        fi
    done
}

{{ else if or (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.id "rhel") (eq .chezmoi.osRelease.id "centos") }}
# MARK: Fedora / RHEL / CentOS
echo "Detected: {{ .chezmoi.osRelease.id }}"

DISTRO_PACKAGES=(
    containerd.io
    docker-buildx-plugin
    docker-ce
    docker-ce-cli
    docker-compose-plugin
    gd-devel
    libpq-devel
    libzip-devel
    oniguruma-devel
    openssh-clients
)

install_packages() {
    local SUDO=""
    if command -v sudo &> /dev/null && [ "$EUID" -ne 0 ]; then
        SUDO="sudo"
    fi

    local PKG_MGR="dnf"
    if ! command -v dnf &> /dev/null; then
        PKG_MGR="yum"
    fi

    # Add Docker official repository
    $SUDO $PKG_MGR install -y dnf-plugins-core || true
    $SUDO $PKG_MGR config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo || true
    $SUDO $PKG_MGR check-update || true

    # Install development tools group
    $SUDO $PKG_MGR groupinstall -y "Development Tools" || true

    for pkg in "$@"; do
        if ! rpm -q "$pkg" &> /dev/null; then
            echo "Installing: $pkg"
            $SUDO $PKG_MGR install -y "$pkg" || echo "Warning: Failed to install $pkg"
        else
            echo "Already installed: $pkg"
        fi
    done
}

{{ else if or (eq .chezmoi.osRelease.id "opensuse-tumbleweed") (eq .chezmoi.osRelease.id "opensuse-leap") }}
# MARK:openSUSE
echo "Detected: {{ .chezmoi.osRelease.id }}"

DISTRO_PACKAGES=(
    docker
    docker-buildx
    docker-compose
    gd-devel
    libzip-devel
    oniguruma-devel
    openssh
    postgresql-devel
)

install_packages() {
    local SUDO=""
    if command -v sudo &> /dev/null && [ "$EUID" -ne 0 ]; then
        SUDO="sudo"
    fi

    $SUDO zypper refresh

    for pkg in "$@"; do
        if ! rpm -q "$pkg" &> /dev/null; then
            echo "Installing: $pkg"
            $SUDO zypper install -y "$pkg" || echo "Warning: Failed to install $pkg"
        else
            echo "Already installed: $pkg"
        fi
    done
}

{{ else }}
# MARK: Unknown distro - try to detect package manager
echo "Unknown distro: {{ .chezmoi.osRelease.id }}"
echo "Attempting to detect package manager..."

DISTRO_PACKAGES=()

install_packages() {
    if command -v apt-get &> /dev/null; then
        echo "Found apt-get, using Debian-style installation"
        sudo apt-get update
        sudo apt-get install -y "$@" build-essential docker.io docker-buildx docker-compose openssh-client
    elif command -v dnf &> /dev/null; then
        echo "Found dnf, using Fedora-style installation"
        sudo dnf install -y dnf-plugins-core
        sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo || true
        sudo dnf install -y "$@" docker-ce docker-ce-cli docker-buildx-plugin docker-compose-plugin openssh-clients
    elif command -v pacman &> /dev/null; then
        echo "Found pacman, using Arch-style installation"
        sudo pacman -Sy --noconfirm "$@" base-devel docker docker-buildx docker-compose openssh
    else
        echo "Could not detect package manager. Please install packages manually."
        exit 1
    fi
}

{{ end }}

# Merge common and distro-specific packages, then install
ALL_PACKAGES=("${COMMON_PACKAGES[@]}" "${DISTRO_PACKAGES[@]}")
install_packages "${ALL_PACKAGES[@]}"

{{ else }}
echo "This script only supports Linux."
exit 0
{{ end }}

echo "==> System packages installation complete!"
