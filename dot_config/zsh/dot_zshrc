# =============================================================================
# History è¨­å®š
# =============================================================================
HISTFILE="$ZDOTDIR/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_DUPS      # é‡è¤‡ã‚’ç„¡è¦–
setopt HIST_IGNORE_ALL_DUPS  # å¤ã„é‡è¤‡ã‚’å‰Šé™¤
setopt HIST_SAVE_NO_DUPS     # ä¿å­˜æ™‚ã«é‡è¤‡ã‚’é™¤å»
setopt SHARE_HISTORY         # ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§å±¥æ­´ã‚’å…±æœ‰
setopt HIST_REDUCE_BLANKS    # ä½™åˆ†ãªç©ºç™½ã‚’å‰Šé™¤

# =============================================================================
# åŸºæœ¬è¨­å®š
# =============================================================================
bindkey -e                   # Emacsã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰
setopt AUTO_CD               # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã ã‘ã§cd
setopt AUTO_PUSHD            # cdæ™‚ã«è‡ªå‹•ã§pushd
setopt PUSHD_IGNORE_DUPS     # pushdã§é‡è¤‡ã‚’ç„¡è¦–

# =============================================================================
# è£œå®Œã‚·ã‚¹ãƒ†ãƒ 
# =============================================================================
autoload -Uz compinit
compinit -d "$ZDOTDIR/.zcompdump"    # â† ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ã“ã“ã«
setopt COMPLETE_IN_WORD      # å˜èªã®é€”ä¸­ã§ã‚‚è£œå®Œ
setopt ALWAYS_TO_END         # è£œå®Œå¾Œã‚«ãƒ¼ã‚½ãƒ«ã‚’æœ«å°¾ã«

# =============================================================================
# fastfetch (system info ãƒ„ãƒ¼ãƒ«)
# https://github.com/fastfetch-cli/fastfetch
# =============================================================================
fastfetch

# =============================================================================
# starship (prompt)
# https://starship.rs/
# =============================================================================
eval "$(starship init zsh)"

# =============================================================================
# Sheldon (zsh/bash ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†)
# https://github.com/rossmacarthur/sheldon
# =============================================================================
eval "$(sheldon source)"

# =============================================================================
# fzf (æ±ç”¨çš„ãªã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ fuzzy finder)
# https://github.com/junegunn/fzf
# =============================================================================

# Set up fzf key bindings and fuzzy completion
source <(fzf --zsh)

# =============================================================================
# Mise (ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«)
# https://mise.jdx.dev
# =============================================================================
eval "$(mise activate zsh)"

# =============================================================================
# ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰è¿½åŠ ï¼ˆHome/Endï¼‰
# =============================================================================
bindkey "^[[H" beginning-of-line
bindkey "^[[F" end-of-line

# =============================================================================
# ã‚¨ã‚¤ãƒªã‚¢ã‚¹
# =============================================================================
# eza settings
# https://github.com/z-shell/zsh-eza
alias ls='eza $eza_params'
alias l='eza --git-ignore $eza_params'
alias ll='eza --all --header --long $eza_params'
alias llm='eza --all --header --long --sort=modified $eza_params'
alias la='eza -lbhHigUmuSa'
alias lx='eza -lbhHigUmuSa@'
alias lt='eza --tree $eza_params'
alias tree='eza --tree $eza_params'

# bat settings
# https://github.com/sharkdp/bat
alias cat="bat --theme-dark default --theme-light GitHub"

# =============================================================================
# é–¢æ•°
# =============================================================================

# brew install/uninstall æ™‚ã« Brewfile ã‚’è‡ªå‹•æ›´æ–°
function brew() {
    command brew "$@"
    local exit_code=$?

    case "$1" in
        install|uninstall|remove)
            if [[ $exit_code -eq 0 ]]; then
                echo "ğŸ“¦ Brewfile ã‚’æ›´æ–°ä¸­..."
                command brew bundle dump --file=~/.Brewfile --force
                if command -v chezmoi &>/dev/null; then
                    chezmoi add ~/.Brewfile
                    echo "âœ… chezmoi ã«åæ˜ ã—ã¾ã—ãŸ"
                fi
            fi
            ;;
    esac

    return $exit_code
}

# NOTE: ghq + fzf + eza Gitãƒªãƒã‚¸ãƒˆãƒªç®¡ç†
# å…±é€š: fzf ã§ãƒªãƒã‚¸ãƒˆãƒªé¸æŠ
function _ghq-fzf_select() {
  ghq list | fzf --preview "eza -l -g -a --icons $(ghq root)/{} | tail -n+4 | awk '{print \$6\"/\"\$8\" \"\$9 \" \" \$10}'"
}

# å‚ç…§â†’ç§»å‹•
function gitls() {
  local src=$(_ghq-fzf_select)
  if [ -n "$src" ]; then
    cd "$(ghq root)/$src"
  fi
}
compdef _nothing gitls

# å–å¾—â†’ç§»å‹•
function gitget() {
  if [ -z "$1" ]; then
    echo "Usage: gitget <repository>"
    return 1
  fi
  ghq get "$@" && cd "$(ghq list -p | grep -E "$(basename ${@: -1} .git)$" | head -1)"
}
compdef _nothing gitget

# å‚ç…§â†’å‰Šé™¤
function gitrm() {
  # æœ€åˆã« ghq root ã‚’å–å¾—ï¼ˆå¾Œã§ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç„¡åŠ¹ã«ãªã‚‹å‰ã«ï¼‰
  local ghq_root="$(ghq root)"

  local src=$(_ghq-fzf_select)
  if [ -z "$src" ]; then
    return 1
  fi

  local repo_path="$ghq_root/$src"
  if [ ! -e "$repo_path" ]; then
    echo "Repository not found: $repo_path"
    return 1
  fi

  echo "Delete: $repo_path"

  # æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
  local uncommitted=$(git -C "$repo_path" -c status.color=always status --short)
  # ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ãªã„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
  local unpushed=$(git -C "$repo_path" log --branches --not --remotes --simplify-by-decoration --decorate --oneline --color=always 2>/dev/null)

  if [ -n "$uncommitted" ] || [ -n "$unpushed" ]; then
    echo "\nâš ï¸  Warning: Uncommitted changes or unpushed commits detected:"
    [ -n "$uncommitted" ] && echo "$uncommitted"
    [ -n "$unpushed" ] && echo "$unpushed"
    echo ""
    read -q "confirm?These changes will be deleted permanently. OK? [y/N]: "
  else
    read -q "confirm?Are you sure? [y/N]: "
  fi
  echo

  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    return 1
  fi

  # å‰Šé™¤å¯¾è±¡å†…ã«ã„ã‚‹å ´åˆã¯å…ˆã«ç§»å‹•ï¼ˆå‰Šé™¤å‰ã«å¿…ãšå®Ÿè¡Œï¼‰
  if [[ "${PWD:A}" == "${repo_path:A}"* ]]; then
    cd "$ghq_root" || cd "$HOME"
  fi

  rm -rf "$repo_path"

  # ç©ºã«ãªã£ãŸè¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‰Šé™¤ï¼ˆghq root ã¾ã§ï¼‰
  local parent="$(dirname "$repo_path")"
  while [ "$parent" != "$ghq_root" ] && [ -d "$parent" ]; do
    if [ -z "$(ls -A "$parent")" ]; then
      rm -rf "$parent"
      parent="$(dirname "$parent")"
    else
      break
    fi
  done

  echo "Successfully deleted: $repo_path"
}
compdef _nothing gitrm
